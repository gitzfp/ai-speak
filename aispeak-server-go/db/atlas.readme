# **âœ… ç¬¬ä¸€æ­¥ï¼šå‡†å¤‡ Atlas é…ç½®æ–‡ä»¶ (`atlas.hcl`)**

ä»¥Â **Standalone mode**Â ä¸ºä¾‹ï¼ˆGORM æ¨¡å‹é›†ä¸­åœ¨ä¸€ä¸ªç›®å½•ä¸‹ï¼Œå¹¶ä½¿ç”¨äº†Â `gorm.Model`Â æˆ–åŒ…å«Â `gorm`Â æ ‡ç­¾ï¼‰ï¼š

```hcl
# atlas.hcl
data"external_schema" "gorm" {
  program = [
    "go", "run", "-mod=mod",
    "ariga.io/atlas-provider-gorm",
    "load",
    "--path", "../models",# GORM æ¨¡å‹ç›®å½•
    "--dialect", "mysql"# æˆ– postgres, sqlite, sqlserver
  ]
}

env "gorm" {
  src = data.external_schema.gorm.url
  dev = "mysql://chatgpt:chatgpt_plus@localhost:3306/fluent_ai_dev"# Atlantis å†…éƒ¨ä½¿ç”¨çš„å¼€å‘æ•°æ®åº“ç¯å¢ƒ
migration {
    dir = "file://migrations"# å­˜æ”¾ç”Ÿæˆè¿ç§»æ–‡ä»¶çš„ç›®å½•
  }
format {
migrate {
      diff = "{{ sql . \"  \" }}"
    }
  }
}

```

å¯é€‰æ­¥éª¤ï¼šä¸ºé˜²æ­¢ä¾èµ–ä¸¢å¤±ï¼Œä½ åº”æ·»åŠ Â `tools.go`Â ä»¥å›ºå®šÂ `atlas-provider-gorm`Â ä¾èµ–ï¼š

```go
// tools.go
//go:build tools
package main

import _ "ariga.io/atlas-provider-gorm/gormschema"

```

ç„¶åè¿è¡Œï¼š

```bash
go mod tidy

```

---

# **âœ… ç¬¬äºŒæ­¥ï¼šåŠ è½½å·²æœ‰æ•°æ®åº“çŠ¶æ€ï¼ˆæ¨èï¼‰**

å»ºè®®ä½¿ç”¨Â `atlas schema inspect`Â å°†ç°æœ‰æ•°æ®åº“ç»“æ„å¯¼å‡ºä¸º SQL æ–‡ä»¶ï¼Œä»è€Œç¡®ä¿ Atlas æŒ‰ç…§å½“å‰çŠ¶æ€è¿›è¡Œå·®å¼‚è®¡ç®—ï¼š

```bash
atlas schema inspect \
  -u "mysql://chatgpt:chatgpt_plus@localhost:3306/fluent_ai" \
  --format '{{ sql . }}' > schema.sql

```

ä½ ä¹Ÿå¯ä»¥è®¾ç½®ä¸€ä¸ªå¤åˆÂ `atlas.hcl`ï¼Œå°†Â `schema.sql`Â ä½œä¸ºåŸºçº¿ã€‚ä¾‹å¦‚ï¼š

```hcl
data"external_schema" "gorm" {
  program = [
    "go", "run", "-mod=mod",
    "ariga.io/atlas-provider-gorm",
    "load",
    "--path", "../models",
    "--dialect", "mysql"
  ]
}

data"sql_schema" "db" {
  url = "file://schema.sql"
}

env "gorm" {
  src = data.external_schema.gorm.url
  dev = "docker://mysql/8/dev"
migration {
    dir = "file://migrations"
  }
diff {
    from = data.sql_schema.db.url
  }
}

```

---

# **âœ… ç¬¬ä¸‰æ­¥ï¼šç”Ÿæˆè¿ç§»æ–‡ä»¶**

æ‰§è¡Œä»¥ä¸‹å‘½ä»¤ï¼ŒAtlas ä¼šè‡ªåŠ¨å¯¹æ¯”Â `from`ï¼ˆæ•°æ®åº“å½“å‰çŠ¶æ€ï¼‰ä¸ GORM æ¨¡å‹å®šä¹‰ï¼Œç”ŸæˆÂ `.sql`Â è¿ç§»æ–‡ä»¶ï¼š

```bash
atlas migrate diff --env gorm

```

ç”Ÿæˆç»“æœç¤ºä¾‹ï¼š

```
migrations/
  â”œâ”€â”€ 20240701123456.sql
  â””â”€â”€ atlas.sum

```

ä½ å¯ä»¥æŸ¥çœ‹Â `.sql`Â æ–‡ä»¶ï¼Œç¡®è®¤å…¶ä¸­åŒ…å«çš„ç»“æ„å˜æ›´ï¼ˆå¦‚åˆ›å»ºè¡¨ã€æ·»åŠ å­—æ®µã€ä¿®æ”¹ç´¢å¼•ç­‰ï¼‰ã€‚

---

# **âœ… ç¬¬å››æ­¥ï¼šè¿ç§»æ‰§è¡Œï¼ˆç”Ÿäº§æˆ– staging ç¯å¢ƒï¼‰**

å¾…ç¡®è®¤æ— è¯¯åï¼Œå¯è¿è¡Œï¼š

```bash
atlas migrate apply \
  --dir "file://migrations" \
  --url "mysql://user:pass@host:3306/dbname"

```

---

# **ğŸ” åç»­è¿ç§»æµç¨‹**

æ¯æ¬¡æ›´æ–° GORM æ¨¡å‹åï¼Œé‡å¤ä»¥ä¸‹æµç¨‹ï¼š

```bash
atlas migrate diff --env gorm

```

Atlas å°†è‡ªåŠ¨æ£€æµ‹æ¨¡å‹å˜åŒ–ï¼Œå¹¶ç”Ÿæˆç›¸åº”çš„è¿ç§»è„šæœ¬ï¼Œå®ç°ä»£ç ä¸æ•°æ®åº“ç‰ˆæœ¬çš„ç»Ÿä¸€ç®¡ç†ã€‚