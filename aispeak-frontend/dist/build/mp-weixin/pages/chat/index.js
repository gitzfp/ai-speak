"use strict";const e=require("../../common/vendor.js"),a=require("../../api/chat.js"),t=require("../../api/account.js"),o=require("../../api/topic.js"),n=require("../../api/textbook.js");if(require("../../axios/api.js"),require("../../config/env.js"),!Array){e.resolveComponent("uni-popup")()}Math||(s+i+l+u+(()=>"../../uni_modules/uni-popup/components/uni-popup/uni-popup.js"))();const s=()=>"../../components/CommonHeader.js",i=()=>"./components/MessageContent.js",l=()=>"./components/Prompt.js",u=()=>"./components/MessageSpeech.js",d=e.defineComponent({__name:"index",setup(s){var i;const l=e.ref({id:void 0,type:void 0,messages:{total:0,list:[]},name:"",completed:0}),u=e.ref([]),d=e.ref(!0),r=e.ref(""),c=e.ref(!0),p=e.ref(0),v=e.ref({detail:{theme_desc:"",chat_nums:0,lesson_id:0},task_target:[]}),_=e.ref({name:"",avatar:"",lesson_id:null,prompt:"",description:""}),m=e.ref([]),h=e.ref({auto_playing_voice:0,auto_text_shadow:0,auto_pronunciation:0,playing_voice_speed:"1.0",speech_role_name_label:"",speech_role_name:"",target_language:""}),g=null==(i=e.getCurrentInstance())?void 0:i.appContext.config.globalProperties.$bus,f=e.ref(null),x=e=>{p.value=e.detail.height},y=e.computed((()=>!(!r.value||!r.value.trim()))),S=e=>{e.text?b(e.text,e.fileName):k(e.fileName)};e.onLoad((a=>{"LESSON"===a.type&&(l.value.type="LESSON",(async e=>{try{const a=await n.textbookRequest.getLessonDetail(e);if(console.log("Chatpage loadLesson API Response:",a),!a.data)throw new Error("No data returned from server");v.value={...a.data,exercise_list:a.data.exercise_list||[]},_.value=a.data.teacher,console.log("Loaded lesson data:",v.value,_.value)}catch(a){console.error("Load lesson error:",a)}})(a.lessonId)),R(a.sessionId,a.sessionName),e.index.setNavigationBarTitle({title:"AI-Speak"}),console.log("Onload",a),g.on("SendMessage",S)})),e.onMounted((()=>{})),e.onBeforeUnmount((()=>{g.off("SendMessage",S)})),e.onShow((()=>{t.accountRequest.getSettings().then((e=>{h.value=e.data}))}));const w=e=>{console.log(e),13===e.keyCode&&T()},T=()=>{if(!y.value)return;const e=r.value;r.value="",b(e)},I=()=>{e.index.navigateTo({url:`/pages/chat/settings?sessionId=${l.value.id}`})},k=t=>{const o=(new Date).getTime(),n={id:o,content:null,owner:!0,file_name:t,role:"USER",auto_hint:!1,auto_play:!1};u.value.push(n),N(),a.chatRequest.transformText({file_name:t,sessionId:l.value.id}).then((a=>{u.value=u.value.filter((e=>e.id!==o));let n=a.data;n&&""!==n.trim()?b(n,t):e.index.showToast({title:"语音转文本失败，请稍后再试.",icon:"none"})}))},b=(t,o)=>{console.log("send file name");const n=(new Date).getTime(),s={id:n,session_id:l.value.id,content:t,owner:!0,file_name:o,role:"USER",auto_hint:!1,auto_play:!1,auto_pronunciation:!1};u.value.push(s);const i=(new Date).getTime()+1,d={id:i,session_id:l.value.id,content:null,owner:!1,file_name:null,role:"ASSISTANT",auto_hint:!1,auto_play:!1,auto_pronunciation:!1,achieved_target:!1};u.value.push(d),N(),a.chatRequest.sessionChatInvoke({sessionId:l.value.id,message:t,file_name:o}).then((a=>{var o;a=a.data,l.value.completed=a.completed,a.achieved_targets&&(null==(o=a.achieved_targets)?void 0:o.length)>0&&t===a.achieved_targets[a.achieved_targets.length-1].user_say&&(s.achieved_target=!0),u.value=u.value.filter((e=>e.id!==i&&e.id!==n)),s.id=null==a?void 0:a.send_message_id,s.auto_pronunciation=!0,u.value.push({...s}),u.value.push({...d,id:a.id,content:a.data,auto_hint:1==h.value.auto_text_shadow,auto_play:1==h.value.auto_playing_voice}),e.nextTick$1((()=>{N()}))})).catch((a=>{e.index.showToast({title:"发送失败..",icon:"none"}),console.error(a),u.value.pop(),u.value.pop()}))},q=()=>{d.value=!d.value},R=(t,o)=>{a.chatRequest.sessionDetailsGet({sessionId:t}).then((n=>{if(l.value=n.data,l.value.name=o,l.value.completed=n.data.completed,u.value=[],0===l.value.messages.total){const o={id:(new Date).getTime(),session_id:l.value.id,content:null,owner:!1,file_name:null,role:"ASSISTANT",auto_hint:!1,auto_play:!1,auto_pronunciation:!1};return u.value.push(o),void a.chatRequest.sessionInitGreeting(t).then((a=>{u.value.pop(),l.value.messages.list.push(a.data),u.value.push({id:a.data.id,session_id:a.data.session_id,content:a.data.content,role:a.data.role,owner:"USER"===a.data.role,auto_hint:1==h.value.auto_text_shadow,auto_play:1==h.value.auto_playing_voice,auto_pronunciation:!1,pronunciation:null}),e.nextTick$1((()=>{N()}))}))}l.value.messages.list.forEach((e=>{u.value.push({id:e.id,session_id:e.session_id,content:e.content,role:e.role,owner:"USER"===e.role,file_name:e.file_name,auto_hint:!1,auto_play:!1,auto_pronunciation:!1,pronunciation:e.pronunciation})})),N()}))},j=()=>{"TOPIC"===l.value.type||"LESSON"===l.value.type?e.index.showModal({title:"是否结束话题",content:"是否结束并且评分话题",success:a=>{a.confirm?C():a.cancel&&e.index.navigateBack()}}):e.index.navigateBack()},C=()=>{o.topicRequest.completeTopic({session_id:l.value.id}).then((a=>{e.index.navigateTo({url:`/pages/topic/completion?sessionId=${l.value.id}&redirectType=index`})}))},L=()=>{const e=v.value.detail.lesson_id;o.topicRequest.createLessonSession({lesson_id:e}).then((e=>{R(e.data.id,e.data.name)}))},N=()=>{0!==u.value.length&&e.nextTick$1((()=>{e.index.pageScrollTo({scrollTop:1e4,duration:100})}))},A=()=>{f.value.open()};return(a,t)=>e.e({a:e.t(l.value.name),b:e.p({"background-color":"#fff",leftIcon:!0,"back-fn":j,title:"聊天"}),c:e.f(u.value,((a,t,o)=>({a:e.sr(m,"7702193b-1-"+o,{k:"messageListRef",f:1}),b:"7702193b-1-"+o,c:e.p({"auto-hint":u.value.auto_text_shadow,"auto-play":h.value.auto_playing_voice,"auto-pronunciation":h.value.auto_pronunciation,message:a}),d:a.id}))),d:!l.value.completed},l.value.completed?{}:e.e({e:!d.value},d.value?{}:{f:e.o(q),g:e.o(x),h:e.o(T),i:e.o([e=>r.value=e.detail.value,w]),j:r.value,k:e.o(T),l:e.unref(y)?1:"",m:e.s("bottom:"+p.value+"px;")},{n:d.value},d.value?e.e({o:c.value},c.value?{p:e.p({sessionId:l.value.id})}:{},{q:e.o(q),r:e.o(I),s:e.p({"session-id":l.value.id})}):{}),{t:l.value.completed},l.value.completed?{v:e.o(L),w:e.o(C)}:{},{x:e.o(A),y:e.t(v.value.detail.theme_desc),z:e.f(v.value.task_target,((t,o,n)=>({a:e.t(t.info_cn),b:e.t(t.info_en),c:e.o((e=>a.playAudio(t.info_en)),o),d:o}))),A:e.o((e=>f.value.close())),B:e.sr(f,"7702193b-4",{k:"popup"}),C:e.p({type:"bottom"})})}}),r=e._export_sfc(d,[["__scopeId","data-v-7702193b"]]);wx.createPage(r);
