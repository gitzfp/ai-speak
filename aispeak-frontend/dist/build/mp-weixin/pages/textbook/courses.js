"use strict";const e=require("../../common/vendor.js"),a=require("../../api/topic.js"),t=require("../../config/env.js");require("../../axios/api.js");const o={setup(){const o=t.__config.basePath,n=e.ref([]),s=e.ref([]),l=e.ref([]),r=e.ref(!1),c=e.ref(null),i=e.ref(0),u=e.ref(""),d=e.ref(1),g=e.ref(1),p=e.ref(null),v=e.ref(!1),h=e.computed((()=>{const e=j();return console.log("当前页面句子:",e),e&&e.length>0})),f=e.ref("");e.onLoad((e=>{f.value=e.book_id,console.log("Received book_id:",f.value)}));const w=async a=>{try{const{data:t}=await e.index.request({url:`${o}/ali-oss/check-file/?oss_key=${a}`,method:"GET"});return t}catch(t){return console.error("检查文件失败:",t),{exists:!1}}},y=async(a,t)=>{try{if(console.log("开始上传文件, ossKey:",a),a.endsWith(".json")){const{data:n}=await e.index.request({url:`${o}/ali-oss/upload-file/?oss_key=${a}`,method:"POST",header:{"Content-Type":"application/json"},data:{oss_key:a,content:t}});return console.log("JSON 数据上传成功:",n),n}if("string"==typeof t&&(t.startsWith("http://")||t.startsWith("https://"))){const a=await new Promise(((a,o)=>{e.index.downloadFile({url:t,success:e=>{200===e.statusCode?a(e.tempFilePath):o(new Error("下载文件失败"))},fail:o})}));t=a}const{data:n}=await e.index.uploadFile({url:`${o}/ali-oss/upload-file/?oss_key=${a}`,filePath:t,name:"file"});return console.log("文件上传成功:",n),"string"==typeof n?JSON.parse(n):n}catch(n){return console.error("文件上传失败:",n),null}},m=async a=>{var t;try{const{data:n}=await e.index.request({url:`${o}/ali-oss/get-file/?oss_key=${a}`,method:"GET",header:{Accept:"application/json","Content-Type":"application/json"}});if(1e3!==n.code)throw new Error(n.message||"获取文件失败");if(a.endsWith(".m3u8"))return null==(t=null==n?void 0:n.data)?void 0:t.content;if(a.endsWith(".json")){const e=JSON.parse(n.data.content);return console.log("解析后的 JSON 内容:",e),e}return n.data.url}catch(n){return console.error("获取文件失败:",n),null}},_=async()=>{try{const{data:a}=await e.index.request({url:`${o}/ap22/user/pep_click/215/access_token.json`,method:"POST",header:{Accept:"*/*","Content-Type":"application/x-www-form-urlencoded",Origin:"https://diandu.mypep.cn",Referer:"https://diandu.mypep.cn/rjdd/"}});return console.log("获取 access_token 成功:",a),a.access_token}catch(a){throw console.error("获取 access_token 失败:",a),a}},x=async(a,t)=>{const{data:n}=await e.index.request({url:`${o}/ap22/resources/ak/pep_click/user/951/urlSignature.json?access_token=${t}`,method:"POST",header:{"Content-Type":"application/x-www-form-urlencoded"},data:{flag:"1",fileNameUrl:`https://szjc-3.mypep.cn${a}`}});return console.log("图片 URL 签名成功:",n),n.url_signature},S=async()=>{var a,t;if(0===n.value.length)return console.error("页面数据未加载"),void(u.value="");const o=null==(a=n.value[i.value])?void 0:a.page_url;if(!o)return console.error("当前页面 URL 未找到"),void(u.value="");const s=`images/${f.value}/${o.split("/").pop()}`,l=await w(s);if(null==(t=null==l?void 0:l.data)?void 0:t.exists)u.value=await m(s),console.log("当前页面图片 URL（来自 OSS）:",u.value);else{const a=await(async e=>{if(!e)return console.error("pageUrl 未定义"),null;let a="Er0iHLzF3oww+9UGQ6wU8U7ZuQQQa011qxMFTQkJj45MGgNjf4QUVVWL6OyOxinnufcJ7SMVceH7M9JWzsnINw==";try{try{return data=await x(e,a),data||(a=await _(),await x(e,a))}catch(t){return console.log("access_token 已失效，重新获取"),a=await _(),await x(e,a)}}catch(t){return console.error("图片 URL 签名获取失败:",t),null}})(o);if(!a)return console.error("获取 URL 签名失败"),void(u.value="");console.log("当前页面图片 URL（来自原接口）:",a),u.value=a;const t=await e.index.request(a),n=await t.blob(),l=new File([n],s.split("/").pop());await y(s,l)}},P=async a=>{try{c.value&&(c.value.stop(),c.value.destroy(),c.value=null);const t=await(async a=>{var t,n,s,l;const r=`audios/${f.value}/${a}.mp3`;console.log("开始获取音频 URL, ossKey:",r);try{const c=await w(r);if(console.log("检查 OSS 文件结果:",c),null==(t=null==c?void 0:c.data)?void 0:t.exists){const e=null==(n=null==c?void 0:c.data)?void 0:n.url;return console.log("从阿里云获取到的 URL:",e),e}{console.log("开始网络请求音频");const t="diandu.mypep.cn"+a,n=e.md5Exports(t),c=`${o}/ap33/api/a/resource/c1ebe466-1cdc-4bd3-ab69-77c3561b9dee/951/${a}/${n}/hlsIndexM3u8.token?access_token=`,i=`https://api.mypep.com.cn/api/a/resource/c1ebe466-1cdc-4bd3-ab69-77c3561b9dee/951/${a}/${n}/hlsIndexM3u8.token?access_token=`;console.log("请求 URL:",c);const u=await new Promise(((a,t)=>{e.index.request({url:c,method:"GET",success:e=>{a(e)},fail:e=>{t(e)}})}));if(!u.data)throw new Error("获取音频数据失败");console.log("获取到的音频数据:",u.data),encodeURIComponent(i),console.log("开始解密和上传");const d=await new Promise(((a,t)=>{e.index.request({url:`${o}/ali-oss/decrypt-and-upload/?oss_key=${r}&url=${i}`,method:"GET",success:e=>{a(e)},fail:e=>{t(e)}})}));if(!d.data)throw new Error("解密上传失败");return console.log("解密上传响应:",d.data),null==(l=null==(s=d.data)?void 0:s.data)?void 0:l.url}}catch(c){return console.error("获取音频 URL 过程中发生错误:",c),null}})(a.res_id);if(!t)throw new Error("获取音频地址失败");return new Promise(((a,o)=>{const n=e.index.createInnerAudioContext();n.src=t,n.autoplay=!0,n.onError((e=>{console.error("音频播放错误:",e),o(new Error("音频播放失败"))})),n.onEnded((()=>{n.destroy(),c.value=null,a()})),c.value=n}))}catch(t){throw console.error("播放音频失败:",t),t}},$=()=>{r.value=!1,c.value&&(c.value.stop(),c.value.destroy(),c.value=null)},b=e.computed((()=>{if(!l.value.length)return"";const e=l.value.find((e=>{const a=e.groups[0].str_page-1,t=a+(e.groups.length||0);return i.value>=a&&i.value<t}));return e?e.chapterName:""}));e.onMounted((async()=>{await(async()=>{try{const a=`json_files/${f.value}_Web.json`,t=await w(a);if(null==t?void 0:t.data.exists){const e=await m(a);n.value=e.chapters.flatMap((e=>e.res_main)),console.log("页面数据获取成功（来自 OSS）:",n.value)}else{const t=`https://rjdduploadw.mypep.cn/pub_cloud/10/${f.value}/${f.value}_Web.json`;console.log("页面数据获取请求开始:",n.value);const o=(await new Promise(((a,o)=>{e.index.request({url:t,method:"GET",success:e=>{a(e)},fail:e=>{o(e)}})}))).data;n.value=o.chapters.flatMap((e=>e.res_main)),console.log("页面数据获取成功（来自原接口）:",n.value);const s=JSON.stringify(o);await y(a,s),console.log("JSON 数据上传成功")}}catch(a){console.error("页面数据获取失败:",a)}})(),await(async()=>{var a;const t=`json_files/${f.value}_sentence.json`,o=await w(t);if(console.log("检查文件是否存在:",o),null==(a=null==o?void 0:o.data)?void 0:a.exists){const e=await m(t);s.value=e.list.flatMap((e=>e.groups.flatMap((e=>e.sentences)))),l.value=e.list,console.log("句子数据获取成功（来自 OSS）:",s.value,l.value)}else try{const a=`https://diandu.mypep.cn/static/textbook/chapter/${f.value}_sentence.json`,o=await new Promise(((t,o)=>{e.index.request({url:a,method:"GET",success:e=>{t(e)},fail:e=>{o(e)}})})),n=await o.data;l.value=n.list,console.log("Chapters data:",l.value),s.value=n.list.flatMap((e=>e.groups.flatMap((e=>e.sentences)))),console.log("句子数据获取成功（来自原接口）:",l.value,s.value);const r=JSON.stringify(n);await y(t,r)}catch(n){console.error("句子数据获取失败:",n)}})(),await S()})),e.onUnmounted((()=>{c.value&&(c.value.stop(),c.value.destroy(),c.value=null)})),e.watch(i,(async()=>{await S()}));const k=e.computed((()=>0===n.value.length?[]:n.value[i.value].track_info)),T=e=>s.value.find((a=>a.res_id===e))||{res_id:e},I=()=>{i.value<n.value.length-1&&i.value++},j=()=>k.value?k.value.map((e=>T(e.res_id))).filter((e=>e&&e.text)).map((e=>({info_en:e.text,info_cn:e.translate_pc}))):[];return{currentPageIndex:i,currentPageImage:u,currentPageSentences:k,prevPage:()=>{i.value>0&&i.value--},nextPage:I,playAudio:P,getSentenceText:T,onImageLoad:a=>{const{width:t,height:o}=a.detail;e.index.createSelectorQuery().select(".book-container").boundingClientRect((e=>{const a=e.width,n=e.height,s=a/t,l=n/o,r=Math.min(s,l);d.value=r,g.value=r,console.log("图片缩放比例:",{scaleX:d.value,scaleY:g.value,naturalWidth:t,naturalHeight:o,containerWidth:a,containerHeight:n})})).exec()},pageImage:p,getScaledPosition:(e,a)=>"x"===a?e*d.value:"y"===a?e*g.value:e,isSidebarOpen:v,toggleSidebar:()=>{v.value=!v.value},goToPage:e=>{i.value=e},pages:n,chapters:l,goToChatPage:async()=>{try{const t=f.value+":"+i.value,o=j(),n=await a.topicRequest.getSessionByLessonId({lesson_id:t});if(null==n?void 0:n.data){const{id:a,name:o}=n.data;if(a)return void e.index.navigateTo({url:`/pages/chat/index?sessionId=${a}&type=LESSON&lessonId=${t}&sessionName=${b.value}`})}const s=await a.topicRequest.createLessonSession({lesson_id:t,sentences:o});if(!(null==s?void 0:s.data))throw new Error("创建会话失败");e.index.navigateTo({url:`/pages/chat/index?sessionId=${s.data.id}&type=LESSON&lessonId=${t}&sessionName=${b.value}`})}catch(t){console.error("创建课程会话失败:",t),e.index.showToast({title:"创建会话失败",icon:"none"})}},hasValidSentences:h,playAllSentences:async()=>{if(r.value)$();else{r.value=!0,console.log("开始连读，当前播放状态:",r.value);try{for(;r.value&&i.value<n.value.length;){const e=k.value;if(e&&0!==e.length){console.log(`开始播放第 ${i.value+1} 页，共 ${e.length} 个句子`);for(let a=0;a<e.length;a++){if(!r.value){console.log("播放被手动停止");break}const t=e[a],o=T(t.res_id);o?(console.log(`播放第 ${a+1} 个句子:`,o),await P(o),r.value&&a<e.length-1&&(console.log("添加 800ms 间隔"),await new Promise((e=>setTimeout(e,800))))):console.warn(`跳过无效句子: ${t.res_id}`)}if(!(r.value&&i.value<n.value.length-1)){console.log("已播放到最后一页，停止连读");break}console.log("切换到下一页"),I(),await new Promise((e=>setTimeout(e,1e3)))}else console.log("当前页面没有句子，切换到下一页"),I()}}catch(a){console.error("连续播放失败:",a),e.index.showToast({title:"连续播放失败",icon:"none"})}finally{console.log("连读结束，重置播放状态"),r.value=!1,c.value&&(c.value.stop(),c.value.destroy(),c.value=null)}}},isPlaying:r,currentChapterName:b}}};if(!Array){e.resolveComponent("View")()}const n=e._export_sfc(o,[["render",function(a,t,o,n,s,l){return e.e({a:e.t(n.isSidebarOpen?"收起目录":"展开目录"),b:e.o(((...e)=>n.toggleSidebar&&n.toggleSidebar(...e))),c:e.f(n.chapters,((a,t,o)=>({a:e.t(a.chapterName),b:e.t(a.groups[0].str_page-1),c:t,d:e.o((e=>n.goToPage(a.groups[0].str_page-2)),t),e:n.currentPageIndex===a.groups[0].str_page-2?1:""}))),d:n.isSidebarOpen?1:"",e:n.currentPageImage},n.currentPageImage?{f:n.currentPageImage,g:e.o(((...e)=>n.onImageLoad&&n.onImageLoad(...e)))}:{},{h:e.f(n.currentPageSentences,((a,t,o)=>({a:a.res_id,b:`${n.getScaledPosition(a.rect_pos_x,"x")}px`,c:`${n.getScaledPosition(a.rect_pos_y,"y")}px`,d:`${n.getScaledPosition(a.rect_width,"x")}px`,e:`${n.getScaledPosition(a.rect_height,"y")}px`,f:e.o((e=>n.playAudio(n.getSentenceText(a.res_id))),a.res_id)}))),i:n.hasValidSentences},n.hasValidSentences?{j:e.o(((...e)=>n.goToChatPage&&n.goToChatPage(...e)))}:{},{k:n.currentPageSentences.length>1},n.currentPageSentences.length>1?{l:e.t(n.isPlaying?"停止":"连读"),m:e.o(((...e)=>n.playAllSentences&&n.playAllSentences(...e)))}:{},{n:0===n.currentPageIndex?1:"",o:e.o(((...e)=>n.prevPage&&n.prevPage(...e))),p:e.t(n.currentPageIndex+1),q:e.t(n.pages.length),r:n.currentPageIndex===n.pages.length-1?1:"",s:e.o(((...e)=>n.nextPage&&n.nextPage(...e)))})}],["__scopeId","data-v-73b68fa0"]]);wx.createPage(n);
