"use strict";const e=require("../../common/vendor.js"),t=require("../../utils/utils.js"),o=require("../../config/env.js"),a=require("../../api/topic.js");require("../../axios/api.js");const n={__name:"books",setup(n){const i=o.__config.basePath,r=e.ref(!0),l=e.ref(""),s=e.ref([]),c=e.ref([]),u=e.ref([]),d=e.ref(""),p=e.ref({}),v=e.ref(0),f=e.ref(!1),g=e.ref(!1),S=e.ref(null),_=e.ref(!1),h=e.ref(!1),y=e.ref(0),k=e.ref(0),w=e.ref([]),b=e.ref("");e.onLoad((o=>{b.value=o.book_id,console.log("Received book_id:",b.value),async function(){var o;try{const a=await async function(){var o,a,n;const r=`proxy/book/${b.value}/getBookUrl.json`,l=await t.utils.checkFileInOSS(r);if(null==(o=null==l?void 0:l.data)?void 0:o.exists){const e=await t.utils.getFileFromOSS(r);return console.log("books.json 已存储，直接从 FastAPI 获取文件 URL",e),e}if(!b.value)throw new Error("Book ID is required");const s=function(e){const t=e.getFullYear(),o=String(e.getMonth()+1).padStart(2,"0"),a=String(e.getDate()).padStart(2,"0"),n=String(e.getHours()).padStart(2,"0"),i=String(e.getMinutes()).padStart(2,"0"),r=String(e.getSeconds()).padStart(2,"0");return`${t}${o}${a}${n}${i}${r}`}(new Date),c=e.CryptoJS.SHA1(`book_id=${b.value}&fixed_key=bac1359d7feb996b396dff38ab77rf7a&timestamp=${s}`).toString();try{const o=await e.index.request({url:`${i}/${r}`,method:"POST",enableHttpDNS:!0,httpDNSServiceId:"wxa410372c837a5f26",data:{book_id:b.value,sign:c,timestamp:s},header:{Accept:"*/*","Content-Type":"application/json",Origin:"https://diandu.mypep.cn",Referer:"https://diandu.mypep.cn/rjdd/","User-Agent":"Mozilla/5.0 (iPhone; CPU iPhone OS 16_6 like Mac OS X) AppleWebKit/605.1.15 (KHTML, like Gecko) Version/16.6 Mobile/15E148 Safari/604.1"}});if(200===o.statusCode&&(null==(a=o.data)?void 0:a.result))return await t.utils.uploadFileToOSS(r,o.data.result),o.data.result;const l=(null==(n=o.data)?void 0:n.message)||"Failed to get book URL";throw console.error("Server response:",o.data),new Error(l)}catch(u){throw console.error("Error getting book URL:",u),u}}(),n=O(a),r=await t.utils.checkFileInOSS(n);if(null==(o=null==r?void 0:r.data)?void 0:o.exists){const o=await t.utils.getFileFromOSS(n,!0),a=new e.JSZip,i=await a.loadAsync(o,{base64:!0}),r=Object.keys(i.files),l=await i.files[r[0]].async("text");if(T(l))return}const l=await e.index.request({url:`https://pdpd.mypep.cn/${n}`,responseType:"arraybuffer"}),s=function(t,o="book.json"){const a=new Array(32).fill(" "),n="".concat(o).concat(a.join("")).substr(0,32),i=e.CryptoJS.enc.Utf8.parse(n),r=e.CryptoJS.enc.Utf8.parse("We Love Manibox!"),l=t[0]|t[1]<<8|t[2]<<16|t[3]<<24,s=e.CryptoJS.lib.WordArray.create(t.slice(4)),c=e.CryptoJS.AES.decrypt({ciphertext:s},i,{iv:r,mode:e.CryptoJS.mode.CBC,padding:e.CryptoJS.pad.Pkcs7}).toString(e.CryptoJS.enc.Hex),u=new Uint8Array(c.match(/../g).map((e=>parseInt(e,16)))),d=Math.min(l,u.length);return u.slice(0,d)}(new Uint8Array(l.data));let c=await async function(t){const o=new e.JSZip;try{const e=await o.loadAsync(t),a=Object.keys(e.files),n=await e.files[a[0]].async("text");return JSON.parse(n)}catch(a){throw console.error("Failed to unzip data:",a),a}}(s);T(c,"Orginal"),console.log("isWechat:",t.utils.isWechat()),t.utils.isWechat()||setTimeout((async()=>{c=await async function(o){try{const a=JSON.parse(JSON.stringify(o));for(let e of a.bookpage){const o=$(e.page_url_source);if(e.page_url_source.startsWith("https://books-bct.oss-cn-beijing.aliyuncs.com")||await t.utils.uploadFileToOSS(O(e.page_url_source),e.page_url_source),e.page_url_source=o,e.track_info)for(let a of e.track_info){const e=$(a.track_url_source);a.track_url_source.startsWith("https://books-bct.oss-cn-beijing.aliyuncs.com")||await t.utils.uploadFileToOSS(O(a.track_url_source),a.track_url_source),a.track_url_source=e}}const n=new e.JSZip;n.file("book.zip",JSON.stringify(a));return await n.generateAsync({type:"arraybuffer",compression:"DEFLATE",compressionOptions:{level:9}})}catch(a){console.error("Resource processing error:",a)}}(c),await t.utils.uploadBinaryData(n,c)}),0)}catch(a){console.error("Error:",a),l.value="加载数据失败，请重试"}finally{r.value=!1}}(),x()}));const x=async()=>{var o;const a=`json_files/${b.value}_sentence.json`,n=await t.utils.checkFileInOSS(a);if(console.log("检查文件是否存在:",n),null==(o=null==n?void 0:n.data)?void 0:o.exists){let e=await t.utils.getFileFromOSS(a);e=JSON.parse(e),u.value=e.list.flatMap((e=>e.groups.flatMap((e=>e.sentences)))),console.log("句子数据获取成功（来OSS）")}else try{const o=`https://diandu.mypep.cn/static/textbook/chapter/${b.value}_sentence.json`,n=await new Promise(((t,a)=>{e.index.request({url:o,method:"GET",enableHttpDNS:!0,httpDNSServiceId:"wxa410372c837a5f26",success:e=>{t(e)},fail:e=>{a(e)}})})),i=await n.data;u.value=i.list.flatMap((e=>e.groups.flatMap((e=>e.sentences)))),console.log("句子数据获取成功（来自原接口）");const r=JSON.stringify(i);await t.utils.uploadFileToOSS(a,r)}catch(i){console.error("句子数据获取失败:",i)}};function m(){if(S.value){e.index.hideToast();try{S.value.stop(),S.value.destroy()}catch(t){console.error("Error stopping audio:",t)}S.value=null}}function O(e){if(!e)return e;let t=e.replace(/^https?:\/\/[^\/]+/,"").replace(/\?.*$/,"");return t.startsWith("/")&&(t=t.slice(1)),t}function $(e){return e?e.replace(/^https?:\/\/[^\/]+/,"https://books-bct.oss-cn-beijing.aliyuncs.com").replace(/\?ts=\d+$/,""):e}const T=(t,o="OSS")=>{var a;try{let n=JSON.parse(t);return console.log(`页面数据获取成功（来自 ${o}）:`),s.value=n.bookpage,c.value=(null==(a=n.bookaudio_v3)?void 0:a.length)>0?n.bookaudio_v3:n.bookaudio_v2,d.value=c.value[0].title,e.index.setNavigationBarTitle({title:c.value[0].title}),r.value=!1,n}catch(n){return console.error("Error parsing JSON data:",n),null}};let j=null;function I(t,o){const a=p.value[o];if(!a)return{};const n=e.index.getSystemInfoSync().windowWidth,i=n*a.ratio;return a.containerWidth!==n&&(a.containerWidth=n),{left:t.track_left*n+"px",top:t.track_top*i+"px",width:(t.track_right-t.track_left)*n+"px",height:(t.track_bottom-t.track_top)*i+"px"}}function E(t){v.value=t.detail.current,m(),g.value=!1,console.log("翻页处理",v.value,c.value);const o=c.value.find((e=>e.page_no===v.value));(null==o?void 0:o.title)&&(d.value=o.title,e.index.setNavigationBarTitle({title:o.title}))}function F(){f.value=!f.value}e.onMounted((()=>{j=new ResizeObserver((()=>{Object.keys(p.value).forEach((t=>{const o=p.value[t];o&&(p.value[t]={...o,containerWidth:e.index.getSystemInfoSync().windowWidth})}))}));const t=document.querySelector(".container");t&&j.observe(t)})),e.onBeforeUnmount((()=>{j&&(j.disconnect(),j=null)}));const J=async()=>{try{const t=b.value+":"+v.value,o=(()=>{const e=u.value.filter((e=>e.jump_page==v.value));return console.log(u.value,v.value,"practiceSentences"),e.map((e=>({info_en:e.text,info_cn:e.translate})))})();if(!o||(null==o?void 0:o.length)<=0)return void e.index.showToast({title:"没有需要测评的口语",icon:"none"});const n=await a.topicRequest.getSessionByLessonId({lesson_id:t});if(null==n?void 0:n.data){const{id:a}=n.data;if(console.log("会话已经存在，句子: ",o,"sessionId: ",a),a)return void e.index.navigateTo({url:`/pages/chat/index?sessionId=${a}&type=LESSON&lessonId=${t}&sessionName=${d.value}`})}console.log("创建新会话，句子: ",o,"sessionId: ");const i=await a.topicRequest.createLessonSession({lesson_id:t,sentences:o});if(!(null==i?void 0:i.data))throw new Error("创建会话失败");e.index.navigateTo({url:`/pages/chat/index?sessionId=${i.data.id}&type=LESSON&lessonId=${t}&sessionName=${d.value}`})}catch(t){console.error("创建课程会话失败:",t),e.index.showToast({title:"创建会话失败",icon:"none"})}};function A(){g.value?S.value&&(S.value.pause(),g.value=!1):function(){const t=s.value[v.value];if(!(null==t?void 0:t.track_info))return;g.value=!0;let o=0;const a=()=>{if(g.value)if(o<t.track_info.length){const n=t.track_info[o],i=e.index.createInnerAudioContext();S.value=i,i.src=n.track_url_source,i.onEnded((()=>{o++,a()})),i.play()}else g.value=!1;else m()};a()}()}function N(){_.value=!0,w.value=s.value[v.value].track_info.map(((e,t)=>`段落 ${t+1}`))}function C(e){y.value=e.detail.value,k.value=e.detail.value}function W(){_.value=!1,h.value=!0,function(){const t=s.value[v.value];if(!(null==t?void 0:t.track_info))return;g.value=!0;let o=y.value;const a=()=>{if(g.value&&h.value){if(o<=k.value){const n=t.track_info[o],i=e.index.createInnerAudioContext();S.value=i,i.src=n.track_url_source,i.onEnded((()=>{o++,o>k.value&&(o=y.value),a()})),i.play()}}else m()};a()}()}function q(){_.value=!1}function M(){h.value=!1,m(),g.value=!1}return e.onBeforeUnmount((()=>{m(),g.value=!1})),(o,a)=>e.e({a:r.value},r.value?{}:l.value?{c:e.t(l.value)}:e.e({d:f.value},f.value?{e:e.o(F)}:{},{f:e.f(c.value,((t,o,a)=>({a:e.t(t.title),b:e.t(t.page_no||o+1),c:t.audio_id,d:e.o((e=>function(e){v.value=e,f.value=!1}(t.page_no||o)),t.audio_id)}))),g:f.value?1:"",h:e.f(s.value,((o,a,n)=>({a:o.page_url_source,b:e.o((a=>async function(o,a){var n;console.error("图片加载失败:",{url:(null==(n=o.target)?void 0:n.src)||"未获取到图片地址",pageId:null==a?void 0:a.page_id,pageUrl:null==a?void 0:a.page_url_source}),e.index.showToast({title:"图片加载失败",icon:"none"});const i=O(a.page_url_source),r=a.page_url_source.replace(/^https?:\/\/[^\/]+/,"https://pdpd.mypep.cn").replace(/\?ts=\d+$/,"");console.log("上传的key:",i,"上传的url:",r),await t.utils.uploadFileToOSS(i,r)}(a,o)),o.page_id),c:e.o((t=>function(t,o){const{width:a,height:n}=t.detail;p.value[o]={width:a,height:n,ratio:n/a,containerWidth:e.index.getSystemInfoSync().windowWidth}}(t,o.page_id)),o.page_id),d:e.f(o.track_info,((t,a,n)=>({a:t.track_id,b:e.s(I(t,o.page_id)),c:e.o((o=>function(t){m();const o=e.index.createInnerAudioContext();S.value=o,o.onError((t=>{console.error("Audio playback error:",t),e.index.hideToast(),e.index.showToast({title:"音频播放失败",icon:"none"})})),o.onPlay((()=>{e.index.showToast({title:t.track_genre,duration:999999,position:"bottom",icon:"none"})})),o.onEnded((()=>{e.index.hideToast(),m()})),o.src=t.track_url_source,o.play()}(t)),t.track_id)}))),e:o.page_id}))),i:v.value,j:e.o(E),k:e.o(F),l:e.t(g.value?"暂停":"连读"),m:e.o(A),n:e.o(N),o:e.o(J),p:_.value},_.value?{q:w.value,r:e.o(C),s:e.o(W),t:e.o(q)}:{},{v:h.value},h.value?{w:e.o(M)}:{}),{b:l.value})}};wx.createPage(n);
