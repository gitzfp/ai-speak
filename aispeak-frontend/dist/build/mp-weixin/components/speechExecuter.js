"use strict";var e=Object.defineProperty,r=(r,o,n)=>(((r,o,n)=>{o in r?e(r,o,{enumerable:!0,configurable:!0,writable:!0,value:n}):r[o]=n})(r,"symbol"!=typeof o?o+"":o,n),n);const o=require("../common/vendor.js"),n=require("../config/env.js"),t=require("../utils/utils.js");const i=new class{constructor(){r(this,"utils",t.utils),r(this,"recorder",{start:!1,processing:!1,remainingTime:0,rec:null,wxRecorderManager:null}),r(this,"intervalId",null),r(this,"listener",{success:null,cancel:null,error:null,interval:null,processing:null})}handleVoiceStart({success:e,cancel:r,error:o,interval:n,processing:t}){let i=this;i.listener.success=e,i.listener.cancel=r,i.listener.error=o,i.listener.interval=n,i.listener.processing=t,i.mpWeixinVoiceStart()}mpWeixinVoiceStart(){let e=this,r=o.index.getRecorderManager();if(!r)return console.error("Failed to get recorder manager"),void(e.listener.error&&e.listener.error("Failed to initialize recorder"));e.recorder.wxRecorderManager=r;try{r.start({duration:6e4,sampleRate:44100,encodeBitRate:192e3,format:"wav"}),e.recorder.start=!0,e.recorder.remainingTime=60,r.onStop((r=>{r&&r.tempFilePath?(console.log("停止微信录音回调。。。",r),e.handleProcessWxEndVoice({filePath:r.tempFilePath}),console.log("停止微信录音回调成功",r)):console.error("No tempFilePath in stop result",r)})),r.onError((r=>{console.error("Recorder error:",r),e.listener.error&&e.listener.error(r)}))}catch(n){console.error("Error starting recorder:",n),e.listener.error&&e.listener.error(n)}}h5VoiceStart(){let e=this;e.recorder.rec=Recorder({type:"wav",bitRate:32,sampleRate:32e3}),e.recorder.rec.open((()=>{e.recorder.start=!0,e.recorder.rec.start(),e.recorder.remainingTime=60,e.intervalId=setInterval((()=>{0===e.recorder.remainingTime?(clearInterval(e.intervalId),e.handleEndVoice()):(e.listener.interval&&e.listener.interval(e.recorder.remainingTime),e.recorder.remainingTime--)}),1e3)}),(r=>{o.index.showToast({title:"请开启录音权限",icon:"none"}),e.listener.error&&e.listener.error(r)}))}handleEndVoice(){let e=this;e.clearInterval(),e.recorder.processing||(e.utils.isWechat()?e.handleWxEndVoice():e.handleH5EndVoice())}clearRecorder(){let e=this;e.recorder.start=!1,e.recorder.processing=!1,e.recorder.rec=null,e.recorder.remainingTime=0}handleWxEndVoice(){console.log("停止微信录音：handleWxEndVoice");let e=this;if(!e.recorder.wxRecorderManager)return console.error("wxRecorderManager is null"),void(e.listener.error&&e.listener.error("Recorder manager not initialized"));try{e.recorder.start&&(e.recorder.wxRecorderManager.stop(),this.clearRecorder())}catch(r){console.error("Error stopping recorder:",r),e.listener.error&&e.listener.error(r)}}handleProcessWxEndVoice({filePath:e}){let r=this;r.listener.processing&&r.listener.processing(),o.index.uploadFile({url:n.__config.basePath+"/voices/upload",filePath:e,header:{"X-Token":o.index.getStorageSync("x-token")},name:"file",success:e=>{console.log("success，微信录音上传成功",e),r.handleUploadResult({resData:e})},fail:e=>{console.error(e,"微信上传失败原因"),o.index.showToast({title:"上传失败",icon:"none"}),r.listener.error&&r.listener.error(e)},complete:()=>{console.log("complete，微信录音上传成功")}})}handleH5EndVoice(){var e;console.log("停止h5录音：handleWxEndVoice");let r=this;r.listener.processing&&r.listener.processing(),null==(e=r.recorder.rec)||e.stop((e=>{o.index.uploadFile({file:e,header:{"X-Token":o.index.getStorageSync("x-token")},name:"file",formData:{file:e},url:n.__config.basePath+"/voices/upload",success:e=>{r.handleUploadResult({resData:e})},fail:e=>{console.error(e,"h5录音上传失败原因"),o.index.showToast({title:"上传失败",icon:"none"})},complete:()=>{r.recorder.start=!1,r.recorder.processing=!1,r.recorder.rec=null}})}),(e=>{r.listener.error&&r.listener.error(e)}))}handleUploadResult({resData:e}){const r=this;if(200==e.statusCode){let n=JSON.parse(e.data);if(1e3!=n.code)return o.index.showToast({title:n.message,icon:"none"}),void(r.listener.error&&r.listener.error(n));r.listener.success&&r.listener.success({inputValue:n.data.result,voiceFileName:n.data.file})}}clearInterval(){this.intervalId&&clearInterval(this.intervalId)}handleCancleVoice(){this.clearInterval(),this.recorder.wxRecorderManager&&(this.recorder.wxRecorderManager.stop(),this.recorder.start=!1,this.recorder.processing=!1,this.recorder.wxRecorderManager=null),this.listener.cancel&&this.listener.cancel()}};exports.speech=i;
