"use strict";const e=require("../common/vendor.js"),o=require("../config/env.js"),t=o.__config.basePath;const n=async(o,r,s=10005)=>{try{if(console.log("开始上传文件, ossKey:",o),o.endsWith(".json")){const{data:n}=await e.index.request({url:`${t}/ali-oss/upload-file/?oss_key=${o}`,method:"POST",header:{"Content-Type":"application/json"},data:{oss_key:o,content:r}});return console.log("JSON 数据上传成功:",n),n}if("string"==typeof r&&(r.startsWith("http://")||r.startsWith("https://"))){const n=await new Promise(((o,t)=>{e.index.downloadFile({url:r,success:e=>{200===e.statusCode?o(e.tempFilePath):t(new Error("下载文件失败"))},fail:t})}));r=n;const{data:a}=await e.index.uploadFile({url:`${t}/ali-oss/upload-file/?oss_key=${o}`,filePath:r,name:"file"});return console.log("文件上传成功:",a),"string"==typeof a?JSON.parse(a):a}a(o,r)}catch(i){return s>0?(console.warn("上传失败，剩余重试次数: "+(s-1),i),n(o,r,s-1)):(console.error("文件上传失败，重试次数已用完:",i),null)}},a=async(o,n)=>{try{const a=n instanceof ArrayBuffer?n:await n.arrayBuffer();if(r()){const n=function(o){let t="";const n=new Uint8Array(o);for(let e=0;e<n.byteLength;e++)t+=String.fromCharCode(n[e]);return e.index.arrayBufferToBase64?e.index.arrayBufferToBase64(o):window.btoa(t)}(a),{data:r}=await e.index.request({url:`${t}/ali-oss/upload-file/?oss_key=${o}`,method:"POST",header:{"Content-Type":"application/json"},data:{oss_key:o,content:n}});return console.log("微信环境上传成功:",r),r}{const e=new FormData,n=new Blob([a],{type:"application/zip"});e.append("file",n,"book.zip"),e.append("oss_key",o);const r=await fetch(`${t}/ali-oss/upload-file/?oss_key=${o}`,{method:"POST",body:e}),s=await r.json();return console.log("非微信环境上传成功:",s),s}}catch(a){throw console.error("上传失败:",a),a}},r=()=>{var o;try{const e=(null==(o=null==navigator?void 0:navigator.userAgent)?void 0:o.toLowerCase())||"";return console.log("User Agent:",e),!e||(/micromessenger/i.test(e)||/miniprogram/i.test(e))}catch(t){const o=e.index.getDeviceInfo();return console.log("System Info:",o),"wechat"===o.platform||"devtools"===o.platform}},s={isWechat:r,removeDecimal:e=>Math.floor(e),getVoiceFileUrl:e=>`${o.__config.basePath}/voices/${e}`,uploadBinaryData:a,uploadFileToOSS:n,getFileFromOSS:async(o,n)=>{var a;try{const{data:r}=await e.index.request({url:`${t}/ali-oss/get-${n?"binary-":""}file/?oss_key=${o}`,method:"GET",header:{Accept:"application/json","Content-Type":"application/json"}});if(1e3!==r.code)throw new Error(r.message||"获取文件失败");return o.endsWith(".m3u8")?null==(a=null==r?void 0:r.data)?void 0:a.content:o.endsWith(".json")?r.data.content:r.data.url}catch(r){return console.error("获取文件失败:",r),null}},checkFileInOSS:async o=>{try{const{data:n}=await e.index.request({url:`${t}/ali-oss/check-file/?oss_key=${o}`,method:"GET"});return n}catch(n){return console.error("检查文件失败:"+o,n),{exists:!1}}},replaceUrl:e=>e?e.replace(/^https?:\/\/[^\/]+/,"https://books-bct.oss-cn-beijing.aliyuncs.com"):e,base64ToArrayBuffer:e=>{const o=atob(e),t=o.length,n=new Uint8Array(t);for(let a=0;a<t;a++)n[a]=o.charCodeAt(a);return n.buffer}};exports.utils=s;
